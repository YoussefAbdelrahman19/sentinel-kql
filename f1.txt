// KQL Query Ù„Ø±ØµØ¯ Mail Bombing ÙÙŠ Sentinel
// ÙŠØ³ØªØ«Ù†ÙŠ Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ ØºÙŠØ± Ø§Ù„Ø­Ø±Ø¬Ø© ÙˆÙŠØ±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡Ø©
 Ø¶
let lookback = 1h; // Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
let threshold = 100; // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø© ÙÙŠ Ø§Ù„ÙØªØ±Ø©
let excludedRecipients = dynamic(["info@", "noreply@", "no-reply@", "donotreply@"]); // Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ù…Ø³ØªØ«Ù†Ø§Ø©

EmailEvents
| where TimeGenerated >= ago(lookback)
| where EmailDirection == "Inbound"
| where DeliveryAction == "Delivered"
// Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ ØºÙŠØ± Ø§Ù„Ø­Ø±Ø¬Ø©
| where not(RecipientEmailAddress has_any (excludedRecipients))
// ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙ„Ù… ÙˆØ§Ù„Ù…ÙˆØ¶ÙˆØ¹ ÙˆØ§Ù„Ù…Ø±Ø³Ù„
| summarize 
    EmailCount = count(),
    FirstSeen = min(TimeGenerated),
    LastSeen = max(TimeGenerated),
    UniqueSenders = dcount(SenderFromAddress),
    SampleSenders = make_set(SenderFromAddress, 10),
    HasAttachments = countif(AttachmentCount > 0),
    HasUrls = countif(UrlCount > 0),
    DeliveryLocations = make_set(DeliveryLocation)
    by RecipientEmailAddress, Subject, bin(TimeGenerated, 10m)
// Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙŠ ØªØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯
| where EmailCount >= threshold
// ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø£ÙƒØ«Ø± Ø®Ø·ÙˆØ±Ø©
| extend Severity = case(
    EmailCount >= 500 and HasUrls > 0, "High",
    EmailCount >= 300, "Medium",
    "Low"
)
| project 
    TimeGenerated,
    RecipientEmailAddress,
    Subject,
    EmailCount,
    UniqueSenders,
    SampleSenders,
    HasAttachments,
    HasUrls,
    Severity,
    FirstSeen,
    LastSeen,
    DeliveryLocations
| sort by EmailCount desc









// Ù‚Ø§Ø¹Ø¯Ø© Ù…ØªÙ‚Ø¯Ù…Ø© ØªØ³ØªØ«Ù†ÙŠ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹Ø©

let lookback = 1h;
let threshold = 150;
let autoReplyPatterns = dynamic(["Automatic Reply", "Out of Office", "Auto-Reply", "Vacation Response"]);
let excludedRecipients = dynamic(["info@", "noreply@", "no-reply@"]);

EmailEvents
| where TimeGenerated >= ago(lookback)
| where EmailDirection == "Inbound"
// Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹Ø© Ù„Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ ØºÙŠØ± Ø§Ù„Ø­Ø±Ø¬Ø©
| extend IsAutoReply = iff(Subject has_any (autoReplyPatterns), true, false)
| extend IsExcludedRecipient = iff(RecipientEmailAddress has_any (excludedRecipients), true, false)
// Ø§Ø³ØªØ«Ù†Ø§Ø¡ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø±Ø¯ÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¹Ù„Ù‰ ØµÙ†Ø§Ø¯ÙŠÙ‚ Ù…Ø³ØªØ«Ù†Ø§Ø©
| where not(IsAutoReply and IsExcludedRecipient)
| summarize 
    EmailCount = count(),
    UniqueSenders = dcount(SenderFromAddress),
    SampleSubjects = make_set(Subject, 5),
    AvgAttachments = avg(AttachmentCount),
    AvgUrls = avg(UrlCount),
    ThreatDetected = countif(ThreatTypes != "")
    by RecipientEmailAddress, bin(TimeGenerated, 10m)
| where EmailCount >= threshold
| extend RiskScore = case(
    ThreatDetected > 0 and EmailCount > 300, 100,
    AvgUrls > 2 and EmailCount > 200, 80,
    EmailCount > 400, 70,
    50
)
| where RiskScore >= 70
| project TimeGenerated, RecipientEmailAddress, EmailCount, UniqueSenders, 
          SampleSubjects, AvgAttachments, AvgUrls, ThreatDetected, RiskScore
| sort by RiskScore desc, EmailCount desc





















EmailEvents
| where Timestamp >= ago(24h)
| where EmailActionPolicy contains "Mail bombing"
    or DetectionMethods contains "Mail bombing"
| summarize 
    EmailCount = count(),
    AffectedUsers = dcount(RecipientEmailAddress),
    Senders = make_set(SenderFromAddress, 20)
    by bin(Timestamp, 1h)
| project Timestamp, EmailCount, AffectedUsers, Senders
| sort by EmailCount desc






let TimeFrame = 1h;
let FailedLogonThreshold = 5;
// Get all AAD DS authentications
let AADDSAuthentications = 
    AADDomainServicesAccountLogon
    | where TimeGenerated > ago(TimeFrame)
    | extend 
        AccountName = tostring(split(tolower(TargetUserName), "@")[0]),
        AccountDomain = tostring(split(tolower(TargetUserName), "@")[1]),
        IsSuccess = iff(ResultType == "0" or ResultType == "Success", true, false)
    | summarize 
        TotalAttempts = count(),
        SuccessfulAttempts = countif(IsSuccess == true),
        FailedAttempts = countif(IsSuccess == false),
        FirstAttempt = min(TimeGenerated),
        LastAttempt = max(TimeGenerated),
        UniqueIPs = dcount(IpAddress),
        IPList = make_set(IpAddress),
        ErrorCodes = make_set(ResultType)
        by TargetUserName, AccountName, AccountDomain;
// Get AAD DC Admin group changes
let AdminGroupChanges = 
    AuditLogs
    | where TimeGenerated > ago(TimeFrame)
    | where OperationName in ("Add member to group", "Add group member")
    | where TargetResources has_any ("AAD DC Administrators", "AADDC")
    | extend 
        InitiatedBy = tostring(InitiatedBy.user.userPrincipalName),
        TargetUser = tostring(TargetResources[0].userPrincipalName),
        Action = "Group Membership Change"
    | project TimeGenerated, InitiatedBy, TargetUser, Action, OperationName;
// Combine and analyze
AADDSAuthentications
| where SuccessfulAttempts > 0 or FailedAttempts >= FailedLogonThreshold
| extend 
    AlertSeverity = case(
        SuccessfulAttempts > 0, "High",
        FailedAttempts >= FailedLogonThreshold, "Medium",
        "Low"
    ),
    AlertDescription = case(
        SuccessfulAttempts > 0, strcat("Successful AAD DS authentication detected for cloud-native user: ", TargetUserName),
        FailedAttempts >= FailedLogonThreshold, strcat("Multiple failed AAD DS authentication attempts (", FailedAttempts, ") detected for: ", TargetUserName),
        "Suspicious activity"
    )
| project-reorder 
    FirstAttempt,
    LastAttempt,
    TargetUserName,
    AlertSeverity,
    AlertDescription,
    TotalAttempts,
    SuccessfulAttempts,
    FailedAttempts,
    UniqueIPs,
    IPList
    
    
    
    
    
let TimeFrame = 1h;
// Union all relevant tables
union 
    // AAD DS Authentication attempts
    (AADDomainServicesAccountLogon
    | where TimeGenerated > ago(TimeFrame)
    | extend 
        User = tostring(TargetUserName),
        SourceIP = tostring(IpAddress),
        AccessType = "AAD DS Authentication",
        Status = tostring(ResultType)),
    // AAD DC related group operations
    (AuditLogs
    | where TimeGenerated > ago(TimeFrame)
    | where TargetResources has_any ("AAD DC", "AADDC") 
        or OperationName has_any ("AAD DC", "AADDC")
    | extend 
        User = tostring(InitiatedBy.user.userPrincipalName),
        SourceIP = tostring(InitiatedBy.user.ipAddress),
        AccessType = strcat("AAD DC Admin Operation: ", OperationName),
        Status = tostring(Result)),
    // AAD DC related sign-ins
    (SigninLogs
    | where TimeGenerated > ago(TimeFrame)
    | where AppDisplayName has_any ("AAD", "Domain", "LDAP", "Kerberos")
        or ResourceDisplayName has_any ("AAD DC", "Domain Services")
    | extend 
        User = tostring(UserPrincipalName),
        SourceIP = tostring(IPAddress),
        AccessType = strcat("Sign-in to: ", AppDisplayName),
        Status = tostring(ResultType)),
    // Azure Activity related to AAD DS
    (AzureActivity
    | where TimeGenerated > ago(TimeFrame)
    | where ResourceProvider == "Microsoft.AAD"
        or OperationNameValue has "DomainServices"
    | extend 
        User = tostring(Caller),
        SourceIP = tostring(CallerIpAddress),
        AccessType = strcat("Azure Operation: ", OperationNameValue),
        Status = tostring(ActivityStatusValue))
| extend 
    IsSuccess = Status in ("0", "Success", "Succeeded", "Accepted")
| project 
    TimeGenerated,
    User,
    SourceIP,
    AccessType,
    Status,
    IsSuccess
| summarize 
    TotalAccess = count(),
    SuccessfulAccess = countif(IsSuccess == true),
    FailedAccess = countif(IsSuccess == false),
    FirstAccess = min(TimeGenerated),
    LastAccess = max(TimeGenerated),
    AccessTypes = make_set(AccessType),
    IPAddresses = make_set(SourceIP)
    by User
    
    
    
    
    
    
    
    




let TimeFrame = 1h;
union 
    // Kerberos Authentication Events
    (AADDomainServicesAccountLogon
    | where TimeGenerated > ago(TimeFrame)
    | extend 
        User = tolower(extract("Logon Account:\\t(.+)", 1, tostring(ResultDescription))),
        SourceIP = tostring(IpAddress),
        EventType = "Kerberos Authentication",
        Details = strcat("Package: ", PackageName, " | Result: ", ResultType)
    | project TimeGenerated, User, SourceIP, EventType, Details, OperationName, ResultType, CorrelationId),
    // Logon/Logoff Events
    (AADDomainServicesLogonLogoff
    | where TimeGenerated > ago(TimeFrame)
    | extend 
        User = tolower(TargetUserName),
        SourceIP = tostring(WorkstationName),
        EventType = "Logon/Logoff",
        Details = strcat("LogonType: ", LogonType, " | AuthPackage: ", AuthenticationPackageName, " | Result: ", ResultType)
    | project TimeGenerated, User, SourceIP, EventType, Details, OperationName, ResultType, CorrelationId),
    // Account Management Activities
    (AADDomainServicesAccountManagement
    | where TimeGenerated > ago(TimeFrame)
    | extend 
        User = coalesce(tolower(SubjectUserName), tolower(extract("Subject Account Name:\\t(.+)", 1, tostring(ResultDescription)))),
        SourceIP = "",
        EventType = "Account Management",
        Details = strcat("Operation: ", OperationName, " | Target: ", coalesce(TargetUserName, SamAccountName, "N/A"))
    | project TimeGenerated, User, SourceIP, EventType, Details, OperationName, ResultType, CorrelationId),
    // Directory Service Access (LDAP Queries)
    (AADDomainServicesDirectoryServiceAccess
    | where TimeGenerated > ago(TimeFrame)
    | extend 
        User = tolower(extract("Subject Account Name:\\t(.+)", 1, tostring(ResultDescription))),
        SourceIP = "",
        EventType = "Directory Access",
        Details = strcat("Operation: ", OperationName)
    | project TimeGenerated, User, SourceIP, EventType, Details, OperationName, ResultType, CorrelationId),
    // Policy Changes
    (AADDomainServicesPolicyChange
    | where TimeGenerated > ago(TimeFrame)
    | extend 
        User = tolower(extract("Subject Account Name:\\t(.+)", 1, tostring(ResultDescription))),
        SourceIP = "",
        EventType = "Policy Change",
        Details = strcat("Operation: ", OperationName)
    | project TimeGenerated, User, SourceIP, EventType, Details, OperationName, ResultType, CorrelationId)
| where isnotempty(User) and User !endswith "$"  // Exclude computer accounts
| project TimeGenerated, User, SourceIP, EventType, Details, OperationName, ResultType, CorrelationId
| sort by TimeGenerated desc









let TimeFrame = 1h;
union 
    // Azure AD Audit Logs - AAD DC Management Operations
    (AuditLogs
    | where TimeGenerated > ago(TimeFrame)
    | where TargetResources has_any ("AAD DC", "AADDC", "Domain Services")
        or OperationName has_any ("AAD DC", "AADDC", "Domain Services")
        or Category == "DirectoryManagement"
    | extend 
        User = tostring(InitiatedBy.user.userPrincipalName),
        SourceIP = tostring(InitiatedBy.user.ipAddress),
        EventType = "AAD DC Management",
        Details = strcat("Operation: ", OperationName, " | Result: ", Result),
        CorrelationId = tostring(CorrelationId)
    | project TimeGenerated, User, SourceIP, EventType, Details, OperationName, Result, CorrelationId),
    // Kerberos Authentication Events
    (AADDomainServicesAccountLogon
    | where TimeGenerated > ago(TimeFrame)
    | extend 
        User = tolower(extract("Logon Account:\\t(.+)", 1, tostring(ResultDescription))),
        SourceIP = tostring(IpAddress),
        EventType = "Kerberos Authentication",
        Details = strcat("Package: ", PackageName, " | Result: ", ResultType)
    | project TimeGenerated, User, SourceIP, EventType, Details, OperationName, ResultType, CorrelationId),
    // Logon/Logoff Events
    (AADDomainServicesLogonLogoff
    | where TimeGenerated > ago(TimeFrame)
    | extend 
        User = tolower(TargetUserName),
        SourceIP = tostring(WorkstationName),
        EventType = "Logon/Logoff",
        Details = strcat("LogonType: ", LogonType, " | AuthPackage: ", AuthenticationPackageName, " | Result: ", ResultType)
    | project TimeGenerated, User, SourceIP, EventType, Details, OperationName, ResultType, CorrelationId),
    // Account Management Activities
    (AADDomainServicesAccountManagement
    | where TimeGenerated > ago(TimeFrame)
    | extend 
        User = coalesce(tolower(SubjectUserName), tolower(extract("Subject Account Name:\\t(.+)", 1, tostring(ResultDescription)))),
        SourceIP = "",
        EventType = "Account Management",
        Details = strcat("Operation: ", OperationName, " | Target: ", coalesce(TargetUserName, SamAccountName, "N/A"))
    | project TimeGenerated, User, SourceIP, EventType, Details, OperationName, ResultType, CorrelationId),
    // Directory Service Access
    (AADDomainServicesDirectoryServiceAccess
    | where TimeGenerated > ago(TimeFrame)
    | extend 
        User = tolower(extract("Subject Account Name:\\t(.+)", 1, tostring(ResultDescription))),
        SourceIP = "",
        EventType = "Directory Access",
        Details = strcat("Operation: ", OperationName)
    | project TimeGenerated, User, SourceIP, EventType, Details, OperationName, ResultType, CorrelationId),
    // Policy Changes
    (AADDomainServicesPolicyChange
    | where TimeGenerated > ago(TimeFrame)
    | extend 
        User = tolower(extract("Subject Account Name:\\t(.+)", 1, tostring(ResultDescription))),
        SourceIP = "",
        EventType = "Policy Change",
        Details = strcat("Operation: ", OperationName)
    | project TimeGenerated, User, SourceIP, EventType, Details, OperationName, ResultType, CorrelationId)
| where isnotempty(User) and User !endswith "$"
| project TimeGenerated, User, SourceIP, EventType, Details, OperationName
| sort by TimeGenerated desc
















let TimeFrame = 1h;
union 
    // Azure AD Audit Logs - AAD DC Management Operations
    (AuditLogs
    | where TimeGenerated > ago(TimeFrame)
    | where TargetResources has_any ("AAD DC", "AADDC", "Domain Services")
        or OperationName has_any ("AAD DC", "AADDC", "Domain Services")
    | extend 
        User = tostring(InitiatedBy.user.userPrincipalName),
        SourceIP = tostring(InitiatedBy.user.ipAddress),
        EventType = "AAD DC Management",
        Details = strcat("Operation: ", OperationName, " | Result: ", Result),
        ResultType = Result,
        CorrelationId = tostring(CorrelationId)
    | project TimeGenerated, User, SourceIP, EventType, Details, OperationName, ResultType, CorrelationId),
    // Kerberos Authentication Events
    (AADDomainServicesAccountLogon
    | where TimeGenerated > ago(TimeFrame)
    | extend 
        User = tolower(extract("Logon Account:\\t(.+)", 1, tostring(ResultDescription))),
        SourceIP = tostring(IpAddress),
        EventType = "Kerberos Authentication",
        Details = strcat("Package: ", PackageName, " | Result: ", ResultType),
        CorrelationId = tostring(CorrelationId)
    | project TimeGenerated, User, SourceIP, EventType, Details, OperationName, ResultType, CorrelationId),
    // Logon/Logoff Events
    (AADDomainServicesLogonLogoff
    | where TimeGenerated > ago(TimeFrame)
    | extend 
        User = tolower(TargetUserName),
        SourceIP = tostring(WorkstationName),
        EventType = "Logon/Logoff",
        Details = strcat("LogonType: ", tostring(LogonType), " | AuthPackage: ", AuthenticationPackageName, " | Result: ", ResultType),
        CorrelationId = tostring(CorrelationId)
    | project TimeGenerated, User, SourceIP, EventType, Details, OperationName, ResultType, CorrelationId),
    // Account Management Activities
    (AADDomainServicesAccountManagement
    | where TimeGenerated > ago(TimeFrame)
    | extend 
        User = coalesce(tolower(SubjectUserName), tolower(extract("Subject Account Name:\\t(.+)", 1, tostring(ResultDescription)))),
        SourceIP = "",
        EventType = "Account Management",
        Details = strcat("Operation: ", OperationName, " | Target: ", coalesce(NewTargetUserName, OldTargetUserName, SamAccountName, UserPrincipalName, "N/A")),
        CorrelationId = tostring(CorrelationId)
    | project TimeGenerated, User, SourceIP, EventType, Details, OperationName, ResultType, CorrelationId),
    // Directory Service Access
    (AADDomainServicesDirectoryServiceAccess
    | where TimeGenerated > ago(TimeFrame)
    | extend 
        User = tolower(extract("Subject Account Name:\\t(.+)", 1, tostring(ResultDescription))),
        SourceIP = "",
        EventType = "Directory Access",
        Details = strcat("Operation: ", OperationName),
        CorrelationId = tostring(CorrelationId)
    | project TimeGenerated, User, SourceIP, EventType, Details, OperationName, ResultType, CorrelationId),
    // Policy Changes
    (AADDomainServicesPolicyChange
    | where TimeGenerated > ago(TimeFrame)
    | extend 
        User = tolower(extract("Subject Account Name:\\t(.+)", 1, tostring(ResultDescription))),
        SourceIP = "",
        EventType = "Policy Change",
        Details = strcat("Operation: ", OperationName),
        CorrelationId = tostring(CorrelationId)
    | project TimeGenerated, User, SourceIP, EventType, Details, OperationName, ResultType, CorrelationId)
| where isnotempty(User) and User !endswith "$"
| project TimeGenerated, User, SourceIP, EventType, Details, OperationName, ResultType
| sort by TimeGenerated desc



https://chatgpt.com/share/690b3777-8d48-8010-ae75-63dfd5500353


AuditLogs
| where TimeGenerated > ago(5m)
| where Category == "EntitlementManagement"
| where OperationName in ("Fulfill access package assignment", "Administrator directly assigns user to access package")
| extend AccessPackageName = tostring(TargetResources[0].displayName)
| extend InitiatorUPN = tostring(InitiatedBy.user.userPrincipalName)
| extend InitiatorDisplayName = tostring(InitiatedBy.user.displayName)
| extend TargetUserUPN = tostring(TargetResources[0].userPrincipalName)
| extend TargetUserDisplayName = tostring(TargetResources[0].displayName)
| where AccessPackageName contains "AAD DC Administrators_emergency"
| project 
    TimeGenerated,
    OperationName,
    Category,
    AccessPackageName,
    InitiatorUPN,
    InitiatorDisplayName,
    TargetUserUPN,
    TargetUserDisplayName,
    Result,
    CorrelationId,
    AADOperationType
    
    
    
    
    
    
    
    AuditLogs
| where TimeGenerated > ago(5m)
| where Category == "EntitlementManagement"
| where OperationName in ("Fulfill access package assignment", "Administrator directly assigns user to access package")
| extend AccessPackageName = tostring(TargetResources[0].displayName)
| extend InitiatorUPN = tostring(InitiatedBy.user.userPrincipalName)
| extend InitiatorDisplayName = tostring(InitiatedBy.user.displayName)
| extend TargetUserUPN = tostring(TargetResources[0].userPrincipalName)
| extend TargetUserDisplayName = tostring(TargetResources[0].displayName)
| where AccessPackageName contains "AAD DC Administrators_emergency"
| project 
    TimeGenerated,
    OperationName,
    Category,
    AccessPackageName,
    InitiatorUPN,
    InitiatorDisplayName,
    TargetUserUPN,
    TargetUserDisplayName,
    Result,
    CorrelationId,
    AADOperationType
    
    
    
    
    
    
    
    
    AuditLogs
| where TimeGenerated > ago(5m)
| where Category == "EntitlementManagement"
| where OperationName in (
    "Fulfill access package assignment request",
    "Administrator directly assigns user to access package",
    "Auto approve access package assignment request"
)
| extend AccessPackageName = tostring(TargetResources[0].displayName)
| extend InitiatorUPN = tostring(InitiatedBy.user.userPrincipalName)
| extend TargetUserUPN = tostring(TargetResources[1].userPrincipalName)
| extend TargetUserDisplayName = tostring(TargetResources[1].displayName)
| project 
    TimeGenerated,
    OperationName,
    AccessPackageName,
    InitiatorUPN,
    TargetUserUPN,
    TargetUserDisplayName,
    Result,
    CorrelationId
    
    
    AuditLogs
| where TimeGenerated > ago(5m)
| where Category == "EntitlementManagement"
| where OperationName in (
    "Fulfill access package assignment request",
    "Administrator directly assigns user to access package",
    "Auto approve access package assignment request"
)
| extend AccessPackageName = tostring(TargetResources[0].displayName)
| where AccessPackageName contains "DC" or AccessPackageName contains "Administrator" or AccessPackageName contains "emergency"
| extend InitiatorUPN = tostring(InitiatedBy.user.userPrincipalName)
| extend TargetUserUPN = tostring(TargetResources[1].userPrincipalName)
| project 
    TimeGenerated,
    OperationName,
    AccessPackageName,
    InitiatorUPN,
    TargetUserUPN,
    Result
    
    
    
    AuditLogs
| where TimeGenerated > ago(5m)
| where Category == "EntitlementManagement"
| where OperationName in (
    "Fulfill access package assignment request",
    "Administrator directly assigns user to access package",
    "Auto approve access package assignment request"
)
| extend AccessPackageName = tostring(TargetResources[0].displayName)
| where AccessPackageName contains "BR_InfoSec_Member"  // ØºÙŠØ± Ø§Ù„Ø§Ø³Ù… Ø¯Ù‡ Ù„Ù„Ù€ package Ø§Ù„Ù„ÙŠ Ø§Ù†Øª Ø¹Ø§ÙŠØ²Ù‡
| extend InitiatorUPN = tostring(InitiatedBy.user.userPrincipalName)
| extend TargetUserUPN = tostring(TargetResources[1].userPrincipalName)
| extend TargetUserDisplayName = tostring(TargetResources[1].displayName)
| project 
    TimeGenerated,
    OperationName,
    AccessPackageName,
    InitiatorUPN,
    TargetUserUPN,
    TargetUserDisplayName,
    Result,
    CorrelationId,
    AADOperationType
    
    
    AuditLogs
| where TimeGenerated > ago(5m)
| where Category == "EntitlementManagement"
| where OperationName in (
    "Fulfill access package assignment request",
    "Administrator directly assigns user to access package",
    "Auto approve access package assignment request"
)
| extend AccessPackageName = tostring(TargetResources[0].displayName)
| where AccessPackageName contains "BR_InfoSec_Member"  // ØºÙŠØ± Ø§Ù„Ø§Ø³Ù… Ø¯Ù‡ Ù„Ù„Ù€ package Ø§Ù„Ù„ÙŠ Ø§Ù†Øª Ø¹Ø§ÙŠØ²Ù‡
| extend InitiatorUPN = tostring(InitiatedBy.user.userPrincipalName)
| extend TargetUserUPN = tostring(TargetResources[1].userPrincipalName)
| extend TargetUserDisplayName = tostring(TargetResources[1].displayName)
| project 
    TimeGenerated,
    OperationName,
    AccessPackageName,
    InitiatorUPN,
    TargetUserUPN,
    TargetUserDisplayName,
    Result,
    CorrelationId,
    AADOperationType
    
    
    
    AuditLogs
| where TimeGenerated > ago(5m)
| where Category == "EntitlementManagement"
| where OperationName in (
    "Fulfill access package assignment request",
    "Administrator directly assigns user to access package",
    "Auto approve access package assignment request"
)
| extend AccessPackageName = tostring(TargetResources[0].displayName)
| extend InitiatorUPN = tostring(InitiatedBy.user.userPrincipalName)
| extend TargetUserUPN = tostring(TargetResources[1].userPrincipalName)
| extend TargetUserDisplayName = tostring(TargetResources[1].displayName)
| project 
    TimeGenerated,
    OperationName,
    AccessPackageName,
    InitiatorUPN,
    TargetUserUPN,
    TargetUserDisplayName,
    Result,
    CorrelationId
    
    
    
    
    
    
AuditLogs
| where TimeGenerated > ago(5m)
| where Category == "EntitlementManagement"
| where OperationName in (
    "Fulfill access package assignment request",
    "Administrator directly assigns user to access package",
    "Auto approve access package assignment request",
    "Ready to fulfill access package assignment request"
)
// Extract all possible fields from different structures
| extend AccessPackageName = coalesce(
    tostring(TargetResources[0].displayName),
    tostring(parse_json(tostring(TargetResources[0].modifiedProperties))[0].newValue)
)
| extend InitiatorUPN = coalesce(
    tostring(InitiatedBy.user.userPrincipalName),
    tostring(InitiatedBy.app.displayName)
)
| extend InitiatorDisplayName = tostring(InitiatedBy.user.displayName)
// Target user can be in different positions
| extend TargetUserUPN = coalesce(
    tostring(TargetResources[1].userPrincipalName),
    tostring(TargetResources[0].userPrincipalName)
)
| extend TargetUserDisplayName = coalesce(
    tostring(TargetResources[1].displayName),
    tostring(TargetResources[0].displayName)
)
| extend TargetUserObjectId = coalesce(
    tostring(TargetResources[1].id),
    tostring(TargetResources[0].id)
)
// Extract additional context
| extend RequestId = tostring(AdditionalDetails[0].value)
| extend IPAddress = tostring(InitiatedBy.user.ipAddress)
| where AccessPackageName contains "DC" or AccessPackageName contains "Administrator" or AccessPackageName contains "emergency"
| project 
    TimeGenerated,
    OperationName,
    Result,
    AccessPackageName,
    InitiatorUPN,
    InitiatorDisplayName,
    TargetUserUPN,
    TargetUserDisplayName,
    TargetUserObjectId,
    IPAddress,
    CorrelationId,
    AADOperationType,
    Category,
    ResourceId
| order by TimeGenerated desc
```

---

## **âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Analytics Rule Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©:**

### **1. General Settings:**

**Name:**
```
[CRITICAL] Privileged Access Package Assignment - DC Administrators Emergency Access
```

**Description:**
```
Detects when a user is assigned to a privileged Domain Controller Administrators emergency access package through Microsoft Entra ID Governance Entitlement Management. This rule monitors direct assignments, automatic fulfillment, and approval-based assignments to high-privilege access packages.

Severity: Critical
MITRE ATT&CK: T1098.003 (Account Manipulation: Additional Cloud Roles)
Data Source: Azure AD Audit Logs - EntitlementManagement Category
```

**Severity:** `Critical`

**MITRE ATT&CK Tactics:**
- Persistence
- Privilege Escalation

**MITRE ATT&CK Techniques:**
- T1098.003 - Account Manipulation: Additional Cloud Roles

---

### **2. Set Rule Logic:**

**Rule Query:** Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù€ Query Ø§Ù„Ù…Ø­Ø³Ù‘Ù† ÙÙˆÙ‚

**Entity Mapping:**
```
Entity Type: Account
- Account: TargetUserUPN (Identifier: UserPrincipalName)
- Account: TargetUserObjectId (Identifier: AadUserId)

Entity Type: Account (Secondary)
- Account: InitiatorUPN (Identifier: UserPrincipalName)

Entity Type: IP (if available)
- Address: IPAddress
```

**Custom Details (Alert Details):**
```
AccessPackage: AccessPackageName
AssignedToUser: TargetUserUPN
AssignedByUser: InitiatorUPN
OperationType: OperationName
Status: Result
```

**Alert Details:**
- Alert Name Format: 
```
CRITICAL - Privileged Access Assigned: {{AccessPackageName}} to {{TargetUserUPN}}
```

---

### **3. Query Scheduling:**

**Run query every:** `5 minutes` â±ï¸

**Lookup data from the last:** `5 minutes` ðŸ“…

**Ù„Ù…Ø§Ø°Ø§ 5 Ø¯Ù‚Ø§Ø¦Ù‚ØŸ**
- âœ… Detection Ø³Ø±ÙŠØ¹ Ù„Ù„Ù€ critical events
- âœ… Ø¨Ø¯ÙˆÙ† overlap ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
- âœ… Real-time alerting ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹
- âœ… Ù…Ø´ Ù‡ÙŠØ¹Ù…Ù„ performance issues

---

### **4. Alert Threshold:**

**Generate alert when number of query results:**
```
Is greater than: 0




// Monitor Access Package Requests - Comprehensive View
AuditLogs
| where TimeGenerated > ago(1h)
| where Category == "EntitlementManagement"
| where OperationName in (
    "Add access package assignment request",
    "Add member to access package assignment",
    "Update access package assignment request",
    "Approve access package assignment request"
)
| extend TargetResource = parse_json(TargetResources[0])
| extend AccessPackage = tostring(TargetResource.displayName)
| extend Requestor = tostring(InitiatedBy.user.userPrincipalName)
| extend TargetUserUPN = tostring(TargetResource.userPrincipalName)
| extend Status = tostring(Result)
| extend RequestState = tostring(parse_json(tostring(TargetResource.modifiedProperties))[0].newValue)
| where AccessPackage contains "AAD DC Administrators_emergency" or AccessPackage contains "Administrators_emergency"
| project
    TimeGenerated,
    OperationName,
    AccessPackage,
    Requestor,
    TargetUserUPN,
    Status,
    RequestState,
    CorrelationId,
    ResultReason,
    AdditionalDetails
| extend
    AccountCustomEntity = TargetUserUPN,
    IPCustomEntity = ""
```

---

## **Analytics Rule Configuration**

### **General Settings**
- **Name**: `Access Package Activation - Emergency DC Administrators`
- **Description**: `Detects when the emergency DC Administrators access package is requested or activated. This is a privileged access package that should be monitored for security purposes.`
- **Severity**: **High**
- **MITRE ATT&CK Tactics**: 
  - Privilege Escalation (TA0004)
  - Persistence (TA0003)
- **MITRE ATT&CK Techniques**:
  - T1078.004 - Valid Accounts: Cloud Accounts
  - T1098 - Account Manipulation

### **Rule Query Settings**
- **Query Frequency**: 1 hour
- **Lookback Period**: 1 hour
- **Alert Threshold**: Greater than 0

### **Entity Mapping**
- **Account**: `AccountCustomEntity`
- **IP Address**: `IPCustomEntity` (if available)

### **Alert Details**
- **Alert Name Format**: `Emergency DC Admin Access Package Requested by {{Requestor}}`
- **Alert Description Format**: 
```
User {{TargetUserUPN}} has been assigned to the emergency DC Administrators access package.
Requestor: {{Requestor}}
Status: {{Status}}
Time: {{TimeGenerated}}
Correlation ID: {{CorrelationId}}






// Monitor Access Package Assignment Requests - Emergency DC Administrators
AuditLogs
| where TimeGenerated > ago(1h)
| where OperationName has_any ("Add member to access package assignment", "Update access package assignment request")
| extend AccessPackageDetails = parse_json(TargetResources[0])
| extend AccessPackageName = tostring(AccessPackageDetails.displayName)
| extend InitiatedBy = tostring(InitiatedBy.user.userPrincipalName)
| extend TargetUser = tostring(TargetResources[0].userPrincipalName)
| extend RequestId = tostring(TargetResources[0].id)
| extend ResultStatus = tostring(Result)
| where AccessPackageName contains "AAD DC Administrators_emergency"
| project 
    TimeGenerated,
    OperationName,
    AccessPackageName,
    InitiatedBy,
    TargetUser,
    ResultStatus,
    RequestId,
    CorrelationId,
    Identity,
    Category,
    AdditionalDetails
| extend 
    AccountCustomEntity = TargetUser,
    HostCustomEntity = ""
    
    
    
    




// Professional approach to extract Access Package data from TargetResources array
AuditLogs
| where TimeGenerated > ago(1h)
| where Category == "EntitlementManagement"
| where OperationName has_any (
    "Add member to access package assignment",
    "Add access package assignment request",
    "Update access package assignment request",
    "Approve access package assignment request"
)
// Expand the TargetResources array to process each object separately
| mv-expand TargetResource = TargetResources
| extend TargetResourceParsed = parse_json(TargetResource)
// Extract all possible fields from each object
| extend 
    ResourceType = tostring(TargetResourceParsed.type),
    ResourceId = tostring(TargetResourceParsed.id),
    ResourceDisplayName = tostring(TargetResourceParsed.displayName),
    ResourceUPN = tostring(TargetResourceParsed.userPrincipalName),
    ResourceModifiedProperties = TargetResourceParsed.modifiedProperties
// Now we filter and aggregate to get the right data
| summarize 
    AccessPackageName = maxif(ResourceDisplayName, ResourceType == "AccessPackage"),
    TargetUserUPN = maxif(ResourceUPN, ResourceType == "User"),
    TargetUserId = maxif(ResourceId, ResourceType == "User"),
    TargetUserDisplayName = maxif(ResourceDisplayName, ResourceType == "User"),
    AccessPackageId = maxif(ResourceId, ResourceType == "AccessPackage"),
    AllResourceTypes = make_set(ResourceType),
    AllDisplayNames = make_set(ResourceDisplayName)
    by 
    TimeGenerated,
    OperationName,
    Result,
    ResultReason,
    CorrelationId,
    InitiatedBy,
    AdditionalDetails,
    Identity
// Extract initiator information
| extend InitiatorUPN = tostring(parse_json(InitiatedBy).user.userPrincipalName)
| extend InitiatorId = tostring(parse_json(InitiatedBy).user.id)
// Filter for our specific access package
| where AccessPackageName contains "AAD DC Administrators_emergency" 
    or AccessPackageName contains "Administrators_emergency"
    or array_length(AllDisplayNames) > 0 and AllDisplayNames has_any ("AAD DC Administrators_emergency", "Administrators_emergency")
// Final projection with clean fields
| project
    TimeGenerated,
    OperationName,
    AccessPackageName,
    AccessPackageId,
    TargetUserUPN,
    TargetUserDisplayName,
    TargetUserId,
    InitiatorUPN,
    InitiatorId,
    Result,
    ResultReason,
    CorrelationId,
    AllResourceTypes,
    AdditionalDetails
| extend
    AccountCustomEntity = TargetUserUPN,
    InitiatorCustomEntity = InitiatorUPN
    
    
    
    https://chatgpt.com/share/690c7aba-237c-8010-8703-9407b2352740
