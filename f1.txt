// KQL Query لرصد Mail Bombing في Sentinel
// يستثني الصناديق غير الحرجة ويركز على الأنماط المشبوهة

let lookback = 1h; // الفترة الزمنية للمراقبة
let threshold = 100; // الحد الأدنى للرسائل المتشابهة في الفترة
let excludedRecipients = dynamic(["info@", "noreply@", "no-reply@", "donotreply@"]); // الصناديق المستثناة

EmailEvents
| where TimeGenerated >= ago(lookback)
| where EmailDirection == "Inbound"
| where DeliveryAction == "Delivered"
// استثناء الصناديق غير الحرجة
| where not(RecipientEmailAddress has_any (excludedRecipients))
// تجميع حسب المستلم والموضوع والمرسل
| summarize 
    EmailCount = count(),
    FirstSeen = min(TimeGenerated),
    LastSeen = max(TimeGenerated),
    UniqueSenders = dcount(SenderFromAddress),
    SampleSenders = make_set(SenderFromAddress, 10),
    HasAttachments = countif(AttachmentCount > 0),
    HasUrls = countif(UrlCount > 0),
    DeliveryLocations = make_set(DeliveryLocation)
    by RecipientEmailAddress, Subject, bin(TimeGenerated, 10m)
// الرسائل التي تتجاوز الحد
| where EmailCount >= threshold
// ترتيب حسب الأكثر خطورة
| extend Severity = case(
    EmailCount >= 500 and HasUrls > 0, "High",
    EmailCount >= 300, "Medium",
    "Low"
)
| project 
    TimeGenerated,
    RecipientEmailAddress,
    Subject,
    EmailCount,
    UniqueSenders,
    SampleSenders,
    HasAttachments,
    HasUrls,
    Severity,
    FirstSeen,
    LastSeen,
    DeliveryLocations
| sort by EmailCount desc









// قاعدة متقدمة تستثني الردود التلقائية المشروعة

let lookback = 1h;
let threshold = 150;
let autoReplyPatterns = dynamic(["Automatic Reply", "Out of Office", "Auto-Reply", "Vacation Response"]);
let excludedRecipients = dynamic(["info@", "noreply@", "no-reply@"]);

EmailEvents
| where TimeGenerated >= ago(lookback)
| where EmailDirection == "Inbound"
// استثناء الردود التلقائية المشروعة للصناديق غير الحرجة
| extend IsAutoReply = iff(Subject has_any (autoReplyPatterns), true, false)
| extend IsExcludedRecipient = iff(RecipientEmailAddress has_any (excludedRecipients), true, false)
// استثناء فقط إذا كانت ردود تلقائية على صناديق مستثناة
| where not(IsAutoReply and IsExcludedRecipient)
| summarize 
    EmailCount = count(),
    UniqueSenders = dcount(SenderFromAddress),
    SampleSubjects = make_set(Subject, 5),
    AvgAttachments = avg(AttachmentCount),
    AvgUrls = avg(UrlCount),
    ThreatDetected = countif(ThreatTypes != "")
    by RecipientEmailAddress, bin(TimeGenerated, 10m)
| where EmailCount >= threshold
| extend RiskScore = case(
    ThreatDetected > 0 and EmailCount > 300, 100,
    AvgUrls > 2 and EmailCount > 200, 80,
    EmailCount > 400, 70,
    50
)
| where RiskScore >= 70
| project TimeGenerated, RecipientEmailAddress, EmailCount, UniqueSenders, 
          SampleSubjects, AvgAttachments, AvgUrls, ThreatDetected, RiskScore
| sort by RiskScore desc, EmailCount desc





















EmailEvents
| where Timestamp >= ago(24h)
| where EmailActionPolicy contains "Mail bombing"
    or DetectionMethods contains "Mail bombing"
| summarize 
    EmailCount = count(),
    AffectedUsers = dcount(RecipientEmailAddress),
    Senders = make_set(SenderFromAddress, 20)
    by bin(Timestamp, 1h)
| project Timestamp, EmailCount, AffectedUsers, Senders
| sort by EmailCount desc






let TimeFrame = 1h;
let FailedLogonThreshold = 5;
// Get all AAD DS authentications
let AADDSAuthentications = 
    AADDomainServicesAccountLogon
    | where TimeGenerated > ago(TimeFrame)
    | extend 
        AccountName = tostring(split(tolower(TargetUserName), "@")[0]),
        AccountDomain = tostring(split(tolower(TargetUserName), "@")[1]),
        IsSuccess = iff(ResultType == "0" or ResultType == "Success", true, false)
    | summarize 
        TotalAttempts = count(),
        SuccessfulAttempts = countif(IsSuccess == true),
        FailedAttempts = countif(IsSuccess == false),
        FirstAttempt = min(TimeGenerated),
        LastAttempt = max(TimeGenerated),
        UniqueIPs = dcount(IpAddress),
        IPList = make_set(IpAddress),
        ErrorCodes = make_set(ResultType)
        by TargetUserName, AccountName, AccountDomain;
// Get AAD DC Admin group changes
let AdminGroupChanges = 
    AuditLogs
    | where TimeGenerated > ago(TimeFrame)
    | where OperationName in ("Add member to group", "Add group member")
    | where TargetResources has_any ("AAD DC Administrators", "AADDC")
    | extend 
        InitiatedBy = tostring(InitiatedBy.user.userPrincipalName),
        TargetUser = tostring(TargetResources[0].userPrincipalName),
        Action = "Group Membership Change"
    | project TimeGenerated, InitiatedBy, TargetUser, Action, OperationName;
// Combine and analyze
AADDSAuthentications
| where SuccessfulAttempts > 0 or FailedAttempts >= FailedLogonThreshold
| extend 
    AlertSeverity = case(
        SuccessfulAttempts > 0, "High",
        FailedAttempts >= FailedLogonThreshold, "Medium",
        "Low"
    ),
    AlertDescription = case(
        SuccessfulAttempts > 0, strcat("Successful AAD DS authentication detected for cloud-native user: ", TargetUserName),
        FailedAttempts >= FailedLogonThreshold, strcat("Multiple failed AAD DS authentication attempts (", FailedAttempts, ") detected for: ", TargetUserName),
        "Suspicious activity"
    )
| project-reorder 
    FirstAttempt,
    LastAttempt,
    TargetUserName,
    AlertSeverity,
    AlertDescription,
    TotalAttempts,
    SuccessfulAttempts,
    FailedAttempts,
    UniqueIPs,
    IPList
    
    
    
    
    
let TimeFrame = 1h;
// Union all relevant tables
union 
    // AAD DS Authentication attempts
    (AADDomainServicesAccountLogon
    | where TimeGenerated > ago(TimeFrame)
    | extend 
        User = tostring(TargetUserName),
        SourceIP = tostring(IpAddress),
        AccessType = "AAD DS Authentication",
        Status = tostring(ResultType)),
    // AAD DC related group operations
    (AuditLogs
    | where TimeGenerated > ago(TimeFrame)
    | where TargetResources has_any ("AAD DC", "AADDC") 
        or OperationName has_any ("AAD DC", "AADDC")
    | extend 
        User = tostring(InitiatedBy.user.userPrincipalName),
        SourceIP = tostring(InitiatedBy.user.ipAddress),
        AccessType = strcat("AAD DC Admin Operation: ", OperationName),
        Status = tostring(Result)),
    // AAD DC related sign-ins
    (SigninLogs
    | where TimeGenerated > ago(TimeFrame)
    | where AppDisplayName has_any ("AAD", "Domain", "LDAP", "Kerberos")
        or ResourceDisplayName has_any ("AAD DC", "Domain Services")
    | extend 
        User = tostring(UserPrincipalName),
        SourceIP = tostring(IPAddress),
        AccessType = strcat("Sign-in to: ", AppDisplayName),
        Status = tostring(ResultType)),
    // Azure Activity related to AAD DS
    (AzureActivity
    | where TimeGenerated > ago(TimeFrame)
    | where ResourceProvider == "Microsoft.AAD"
        or OperationNameValue has "DomainServices"
    | extend 
        User = tostring(Caller),
        SourceIP = tostring(CallerIpAddress),
        AccessType = strcat("Azure Operation: ", OperationNameValue),
        Status = tostring(ActivityStatusValue))
| extend 
    IsSuccess = Status in ("0", "Success", "Succeeded", "Accepted")
| project 
    TimeGenerated,
    User,
    SourceIP,
    AccessType,
    Status,
    IsSuccess
| summarize 
    TotalAccess = count(),
    SuccessfulAccess = countif(IsSuccess == true),
    FailedAccess = countif(IsSuccess == false),
    FirstAccess = min(TimeGenerated),
    LastAccess = max(TimeGenerated),
    AccessTypes = make_set(AccessType),
    IPAddresses = make_set(SourceIP)
    by User
    
    
    
    
    
    
    
    




let TimeFrame = 1h;
union 
    // Kerberos Authentication Events
    (AADDomainServicesAccountLogon
    | where TimeGenerated > ago(TimeFrame)
    | extend 
        User = tolower(extract("Logon Account:\\t(.+)", 1, tostring(ResultDescription))),
        SourceIP = tostring(IpAddress),
        EventType = "Kerberos Authentication",
        Details = strcat("Package: ", PackageName, " | Result: ", ResultType)
    | project TimeGenerated, User, SourceIP, EventType, Details, OperationName, ResultType, CorrelationId),
    // Logon/Logoff Events
    (AADDomainServicesLogonLogoff
    | where TimeGenerated > ago(TimeFrame)
    | extend 
        User = tolower(TargetUserName),
        SourceIP = tostring(WorkstationName),
        EventType = "Logon/Logoff",
        Details = strcat("LogonType: ", LogonType, " | AuthPackage: ", AuthenticationPackageName, " | Result: ", ResultType)
    | project TimeGenerated, User, SourceIP, EventType, Details, OperationName, ResultType, CorrelationId),
    // Account Management Activities
    (AADDomainServicesAccountManagement
    | where TimeGenerated > ago(TimeFrame)
    | extend 
        User = coalesce(tolower(SubjectUserName), tolower(extract("Subject Account Name:\\t(.+)", 1, tostring(ResultDescription)))),
        SourceIP = "",
        EventType = "Account Management",
        Details = strcat("Operation: ", OperationName, " | Target: ", coalesce(TargetUserName, SamAccountName, "N/A"))
    | project TimeGenerated, User, SourceIP, EventType, Details, OperationName, ResultType, CorrelationId),
    // Directory Service Access (LDAP Queries)
    (AADDomainServicesDirectoryServiceAccess
    | where TimeGenerated > ago(TimeFrame)
    | extend 
        User = tolower(extract("Subject Account Name:\\t(.+)", 1, tostring(ResultDescription))),
        SourceIP = "",
        EventType = "Directory Access",
        Details = strcat("Operation: ", OperationName)
    | project TimeGenerated, User, SourceIP, EventType, Details, OperationName, ResultType, CorrelationId),
    // Policy Changes
    (AADDomainServicesPolicyChange
    | where TimeGenerated > ago(TimeFrame)
    | extend 
        User = tolower(extract("Subject Account Name:\\t(.+)", 1, tostring(ResultDescription))),
        SourceIP = "",
        EventType = "Policy Change",
        Details = strcat("Operation: ", OperationName)
    | project TimeGenerated, User, SourceIP, EventType, Details, OperationName, ResultType, CorrelationId)
| where isnotempty(User) and User !endswith "$"  // Exclude computer accounts
| project TimeGenerated, User, SourceIP, EventType, Details, OperationName, ResultType, CorrelationId
| sort by TimeGenerated desc
